<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{/general/head.html}"></div>
<meta name="_csrf" content="${_csrf.token}"/>
<meta name="_csrf_header" content="${_csrf.headerName}"/>
<link rel="stylesheet" th:href="@{/css/bootstrap-wysihtml5.css}"/>
<link th:href="@{/css/style.min.css}" rel="stylesheet">
<link th:href="@{/css/pages/inbox.css}" rel="stylesheet">

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:insert="~{/general/header.html}"></div>
    <div th:insert="~{/general/left-sidebar.html}"></div>

    <div class="page-wrapper">
        <div class="container-fluid">
            <div th:insert="~{/general/page-titles.html}"></div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Créer un nouveau budget</h4>
                            <form id="depenseForm" th:action="@{/depenses/save}" method="post">
                                <label for="montant" class="m-t-20">Montant:</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="montant" name="montant" step="0.01" required>
                                </div>
                            
                                <label for="dateDepense" class="m-t-20">Date de la Dépense:</label>
                                <div class="input-group">
                                    <input type="datetime-local" class="form-control" id="dateDepense" name="dateDepense" required>
                                </div>
                            
                                <label for="ticket" class="m-t-20">Ticket (Optionnel):</label>
                                <div class="input-group">
                                    <select class="form-control" id="ticket" name="ticketId">
                                        <option value="">-- Aucun --</option>
                                        <option th:each="ticket : ${tickets}" 
                                                th:value="${ticket.ticketId}" 
                                                th:text="${ticket.subject}">
                                        </option>
                                    </select>
                                </div>
                            
                                <label for="lead" class="m-t-20">Lead (Optionnel):</label>
                                <div class="input-group">
                                    <select class="form-control" id="lead" name="leadId">
                                        <option value="">-- Aucun --</option>
                                        <option th:each="lead : ${leads}" 
                                                th:value="${lead.leadId}" 
                                                th:text="${lead.name}">
                                        </option>
                                    </select>
                                </div>
                            
                                <label for="budget" class="m-t-20">Budget:</label>
                                <div class="input-group">
                                    <select class="form-control" id="budgetId" name="budgetId" required>
                                        <option th:each="budget : ${budgets}" 
                                                th:value="${budget.id}" 
                                                th:text="${budget.name}">
                                        </option>
                                    </select>
                                </div>
                            
                                <label for="taux" class="m-t-20">Taux d'Alerte Actuel:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="taux" th:value="${taux.taux}" readonly>
                                </div>
                            
                                <button type="submit" id="confirmButton" class="btn btn-primary m-t-20">Enregistrer</button>

                                <a th:href="@{/depenses}" class="btn btn-secondary m-t-20">Annuler</a>
                            </form>
                            
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal -->
            <div id="confirmationModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <h3>Attention</h3>
                    <p id="modalMessage">Le montant restant du budget a atteint ou est inférieur à un seuil. Voulez-vous continuer ?</p>
                    <button id="confirmModalButton" onclick="confirmAction()">Exécuter</button>
                    <button id="cancelModalButton">Annuler</button>


                </div>
            </div>


            <div th:insert="~{/general/right-sidebar.html}"></div>
        </div>

    </div>

    <div th:insert="~{/general/footer.html}"></div>
</div>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('depenseForm');
        const confirmButton = document.getElementById('confirmButton');
        const cancelModalButton = document.getElementById('cancelModalButton');
    
        let pendingSubmission = false;
    
        // Gestion du bouton de confirmation
        confirmButton.addEventListener('click', function (event) {
            if (!pendingSubmission) {
                event.preventDefault(); // Bloquer la soumission initiale
                checkBudgetAndSubmit();
            }
        });

        // Gestion du bouton "Annuler" de la modal
        cancelModalButton.addEventListener('click', function () {
            closeModal();
        });
    
        // Fonction pour afficher la modal
        function showModal(message, confirmRequired = true) {
            const modal = document.getElementById('confirmationModal');
            const modalMessage = document.getElementById('modalMessage');
            const confirmModalButton = document.getElementById('confirmModalButton');
        
            modalMessage.textContent = message;
            modal.style.display = "block";
        
            if (!confirmRequired) {
                setTimeout(() => {
                    pendingSubmission = true;
                    form.submit();
                    closeModal();
                }, 3000);
            } else {
                confirmModalButton.onclick = function () {
                    pendingSubmission = true;
                    form.submit();
                    closeModal();
                };
            }
        }
            
        // Fonction pour fermer la modal
        function closeModal() {
            const modal = document.getElementById('confirmationModal');
            modal.style.display = "none";
        }
    
        // Vérification du budget et soumission du formulaire
        function checkBudgetAndSubmit() {
            const montantInput = document.getElementById('montant');
            const budgetSelect = document.getElementById('budgetId');
        
            const tauxValue = Number(/*[[${taux.taux}]]*/ 0);
            const budgets = /*[[${budgets}]]*/ [];

            console.log('Budgets:', budgets); // Vérifie si les données sont bien injectées
        
            const montantUtilisateur = parseFloat(montantInput.value) || 0;
            const selectedBudget = budgets.find(b => b.id == budgetSelect.value);
        
            if (selectedBudget) {
                const montantRestant = selectedBudget.montantRestant;
                const seuil = selectedBudget.montant * tauxValue / 100;
                const montantRestantApres = montantRestant - montantUtilisateur;
                if (montantRestantApres < 0) {
                    showModal(`⚠️ Attention: Le montant restant du budget est inférieur à 0. Voulez-vous quand même continuer ?`);
                }
                else if (montantRestantApres <= seuil) {
                    showModal(`⚠️ Attention: Le montant restant du budget est inférieur à ${seuil.toFixed(2)}. Voulez-vous quand même continuer ?`);
                } else {
                    showModal(`✅ Le montant restant est suffisant. La soumission se fera automatiquement.`, false);
                }
            } else {
                pendingSubmission = true;
                form.submit();
            }
        }
    });
</script>

            



<style>
    /* Le fond de la modal (overlay) */
    .modal {
        display: none; /* Masqué par défaut */
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
    }
    
    /* Contenu de la modal */
    .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        text-align: center;
    }
    
    /* Boutons de la modal */
    .modal-content button {
        margin: 10px;
        padding: 10px 20px;
        border: none;
        background-color: #4CAF50;
        color: white;
        cursor: pointer;
    }
    
    .modal-content button:hover {
        background-color: #45a049;
    }
    
    /* Bouton de fermeture */
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
    }
    
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    
</style>
<script th:src="@{/js/library/jquery-3.2.1.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/popper.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/waves.js}" type="text/javascript"></script>
<script th:src="@{/js/library/sidebarmenu.js}" type="text/javascript"></script>
<script th:src="@{/js/library/custom.min.js}" type="text/javascript"></script>

</body>
</html>
